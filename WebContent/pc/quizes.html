<!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<title> 平安校园后台管理系统 </title>
		<meta name="description" content="">
		<meta name="author" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<!-- Basic Styles -->
		<link rel="stylesheet" type="text/css" media="screen" href="css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" media="screen" href="css/font-awesome.min.css">
		<!-- SmartAdmin Styles : Caution! DO NOT change the order -->
		<link rel="stylesheet" type="text/css" media="screen" href="css/smartadmin-production-plugins.min.css">
		<link rel="stylesheet" type="text/css" media="screen" href="css/smartadmin-production.min.css">
		<link rel="stylesheet" type="text/css" media="screen" href="css/smartadmin-skins.min.css">
		<!-- SmartAdmin RTL Support  -->
		<link rel="stylesheet" type="text/css" media="screen" href="css/smartadmin-rtl.min.css">
		<link rel="stylesheet" type="text/css" media="screen" href="css/demo.min.css">
		<!-- FAVICONS -->
		<link rel="shortcut icon" href="img/favicon/favicon.ico" type="image/x-icon">
		<link rel="icon" href="img/favicon/favicon.ico" type="image/x-icon">
		<!-- GOOGLE FONT -->
		<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,300,400,700">
		<!-- Specifying a Webpage Icon for Web Clip 
			 Ref: https://developer.apple.com/library/ios/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html -->
		<link rel="apple-touch-icon" href="img/splash/sptouch-icon-iphone.png">
		<link rel="apple-touch-icon" sizes="76x76" href="img/splash/touch-icon-ipad.png">
		<link rel="apple-touch-icon" sizes="120x120" href="img/splash/touch-icon-iphone-retina.png">
		<link rel="apple-touch-icon" sizes="152x152" href="img/splash/touch-icon-ipad-retina.png">
	</head>
	<body class="">
		<!-- HEADER -->
		<header id="header">
			<div id="logo-group">
				<!-- PLACE YOUR LOGO HERE -->
				<span id="logo"> <img src="img/logo.png" alt="SmartAdmin"> </span>		
			</div>
			<!-- pulled right: nav area -->
			<div class="pull-right">
				<!-- collapse menu button -->
				<div id="hide-menu" class="btn-header pull-right">
					<span> <a href="javascript:void(0);" data-action="toggleMenu" title="Collapse Menu"><i class="fa fa-reorder"></i></a> </span>
				</div>
				<!-- end collapse menu -->
				<!-- logout button -->
				<div id="logout" class="btn-header transparent pull-right">
					<span> <a href="login.html" title="Sign Out" data-action="userLogout" data-logout-msg="You can improve your security further after logging out by closing this opened browser"><i class="fa fa-sign-out"></i></a> </span>
				</div>
				<div id="Name" class="btn-header transparent pull-right">
					<span> <a href="#">平安校园管理员</a> </span>
				</div>
				<!-- end logout button -->
			</div>
			<!-- end pulled right: nav area -->
		</header>
		<!-- END HEADER -->
		<!-- Left panel : Navigation area -->
		<aside id="left-panel">
			<!-- NAVIGATION : This navigation is also responsive-->
			<nav>
				<ul>
					<li>
						<a href="index.html" title="Dashboard"><i class="fa fa-lg fa-fw fa-home"></i> <span class="menu-item-parent">首页</span></a>
					</li>
					<li>
						<a href="#"><i class="fa fa-lg fa-fw fa-cog"></i> <span class="menu-item-parent">系统设置</span></a>
						<ul>
							<li>
								<a href="account_manage.html">账号管理</a>
							</li>
							<li>
								<a href="wx_config.html">微信接口设置</a>
							</li>
							<li>
								<a href="import_students.html">导入学生数据</a>
							</li>
						</ul>
					</li>
					<li>
							<a href="course.html"><i class="fa fa-lg fa-fw fa-play"></i> <span class="menu-item-parent">课程设置</span></a>
						</li>
					<li class="active">
						<a href="#"><i class="fa fa-lg fa-fw fa-pencil-square-o"></i> <span class="menu-item-parent">题库设置</span></a>
						<ul>
							<li>
								<a href="knowledge.html">知识点设置</a>
							</li>
							<li>
								<a href="questions.html">题目设置</a>
							</li>
							<li>
									<a href="import_questions.html">题目导入</a>
							</li>
							<li class="active">
								<a href="quizes.html">试卷设置</a>
							</li>
							<li>
								<a href="quizes_d.html">试卷回收站</a>
							</li>
						</ul>
					</li>
			</nav>
			<span class="minifyme" data-action="minifyMenu"> 
				<i class="fa fa-arrow-circle-left hit"></i> 
			</span>

		</aside>
		<!-- END NAVIGATION -->
		<!-- MAIN PANEL -->
		<div id="main" role="main">

			<!-- MAIN CONTENT -->
			<div id="content">
				<article class="col-sm-12 col-md-12 col-lg-2">
					<!-- Widget ID (each widget will need unique ID)-->
					<div class="jarviswidget jarviswidget-color-blue" id="wid-id-1" data-widget-editbutton="false">
						<header>
							<span class="widget-icon"> <i class="fa fa-sitemap"></i> </span>
							<h2>试卷列表</h2>
						</header>
						<!-- widget div-->
						<div class="col-sm-6 col-lg-4">
							<div id="tree"></div>
						</div>	
						<!-- end widget div -->
					</div>
					<!-- end widget -->
				</article>	
				<article class="col-sm-12 col-md-12 col-lg-10">
					<!-- Widget ID (each widget will need unique ID)-->
					<div class="jarviswidget" id="wid-id-0" data-widget-colorbutton="false" data-widget-editbutton="false">
						<header>
							<span class="widget-icon"> <i class="fa fa-eye"></i> </span>
							<h2>试卷设置</h2>
						</header>
						<!-- widget div-->
						<div>
							<!-- widget content -->
							<div class="widget-body">
								<form class="form-horizontal">
									<fieldset>
										<div class="form-group">
											<label class="control-label col-md-2">选择试卷类型</label>
											<div class="col-md-4">
											<select class="form-control" id="quiztype">
												<option value='formal'>正式考试</option>
												<option value='simulate'>模拟考试</option>
											</select>
											</div>
										</div>
									</fieldset>
									<fieldset>
										<div class="form-group">
											<label class="col-md-2 control-label">试卷名称</label>
											<div class="col-md-4">
												<input class="form-control" placeholder="" type="text" id="quizname">
											</div>
										</div>
										<div class="form-group">
											<label class="col-md-2 control-label">考试开始时间</label>
											<div class="col-md-4">
												<a href="form-x-editable.html#" id="starttime" data-type="combodate" data-template="YYYY MMM D   HH:mm" data-format="YYYY-MM-DD HH:mm" data-viewformat="YYYY年MMMD号,HH:mm" data-pk="1" data-original-title="选择考试开始时间">请选择时间</a></td>
											</div>
										</div>
										
										<div class="form-group">
											<label class="col-md-2 control-label">考试结束时间</label>
											<div class="col-md-4">
												<a href="form-x-editable.html#" id="endtime" data-type="combodate" data-template="YYYY MMM D   HH:mm" data-format="YYYY-MM-DD HH:mm" data-viewformat="YYYY年MMMD号,HH:mm" data-pk="1" data-original-title="选择考试结束时间">请选择时间</a></td>
											</div>
										</div>
										
										<div class="form-group">
											<label class="col-md-2 control-label">考试时长</label>
											<div class="col-md-1">
												<input class="form-control" placeholder="" type="text" id="timelast">
											</div>
											<label class="control-label">分钟</label>
										</div>
										<div class="form-group">
											<label class="col-md-2 control-label">总分</label>
											<div class="col-md-1">
												<input class="form-control" placeholder="" type="text" disabled="disabled" id="totalscore">
											</div>
											<label class="control-label">分</label>
										</div>
										<div class="form-group">
											<label class="col-md-2 control-label">及格分数</label>
											<div class="col-md-1">
												<input class="form-control" placeholder="" type="text" id="passscore">
											</div>
											<label class="control-label">分</label>
										</div>
										<div class="form-group">
											<label class="col-md-2 control-label">次数限制</label>
											<div class="col-md-1">
												<input class="form-control" placeholder="" type="text" id="timelimits">
											</div>
											<label class="control-label">次</label>
										</div>
										<input type="hidden" id="quizid" value="-1" />	
									</fieldset>
									<fieldset> 
										<legend>
											 成绩下载
										</legend>
										<div class="row">
											<div class="col-md-11 pull-right">
												<button class="btn btn-default"  type="button" onclick="DownloadGrades()">下载成绩</button>
												<button class="btn btn-default"  type="button" onclick="DownloadRecords()">下载答题记录</button>
												<button class="btn btn-default" type="button" id="custom_download">自定义下载</button>
												<button class="btn btn-default" type="button">查看统计图表</button>
											</div>
										</div>
									</fieldset>
								</form>
								<div class="form-actions">
										<div class="row">
											<div class="col-md-12">
												<button class="btn btn-default" type="button" onclick="addquiz();"><i class="fa fa-plus"></i>添加新试卷</button>
												<button class="btn btn-default"  type="button" onclick="addconfig();"><i class="fa fa-plus"></i>添加配置项</button>
												<button class="btn btn-default" type="button" onclick="">取消</button>
												<button class="btn btn-primary" type="button" onclick="deletequiz();"><i class="fa fa-save"></i>删除试卷</button>
												<button class="btn btn-primary" type="button" onclick="savequiz();"><i class="fa fa-save"></i>保存修改</button>
											</div>
										</div>
									</div>
							</div>
							<!-- end widget content -->
						</div>
						<!-- end widget div -->
					</div>
					<!-- end widget -->
				</article>
				<article class="col-sm-12 col-md-12 col-lg-10 pull-right">
								<!-- Widget ID (each widget will need unique ID)-->
								<div class="jarviswidget" id="wid-id-0" data-widget-colorbutton="false" data-widget-editbutton="false">
									<header>
										<span class="widget-icon"> <i class="fa fa-eye"></i> </span>
										<h2>试卷配置</h2>
									</header>
									<!-- widget div-->
									<div>
									<div class="widget-body">						
									<!-- widget content -->
									<form class="smart-form" id="quizconfiglist">
										
									</form>
									<!-- end widget content -->
									</div>
									</div>
									<!-- end widget div -->
								</div>
								<!-- end widget -->
				</article>
				<div id="dialog_simple" title="选择筛选条件" class="widget-body">
				<form class="smart-form" id="#">
				<fieldset>
					<div class="row">
					<section class="col col-md-4">
						<label style="color:black">学院：</label>
						<div class="col-md-10">
							<select class="form-control" id="collegelist">
								<option value="department">全部</option>
							</select>
						</div>
					</section>
					<section class="col col-md-4">
						<label style="color:black">身份：</label>
						<div class="col-md-10">
							<select class="form-control" id="rolelist">
								<option value="role">全部</option>
							</select>
						</div>
					</section>
					<section class="col col-md-4">
						<label style="color:black">年级：</label>
						<div class="col-md-10">
							<select class="form-control" id="yearlist">
								<option value="year">全部</option>
							</select>
						</div>
					</section>
					<section class="col col-md-4">
						<label style="color:black">成绩：</label>
						<div class="col-md-10">
							<select class="form-control" id="gradestype">
								<option value="all">全部</option>
								<option value="pass">及格</option>
								<option value="unpass">不及格</option>
								<option value="absent">未参加考试</option>
							</select>
						</div>
					</section>
					</div>
				</fieldset>
					
				</div>
			</div>
			<!-- end row -->					
		</section>
		<!-- end widget grid -->
		</div>
		<!-- END MAIN CONTENT -->

		<!-- PAGE FOOTER -->
		<div class="page-footer">
			<div class="row">
				<div class="col-xs-12 col-sm-6">
					<span class="txt-color-white">平安校园后台管理系统</span>
				</div>
			</div>
		</div>
		<!-- END PAGE FOOTER -->
		<script data-pace-options='{ "restartOnRequestAfter": true }' src="js/plugin/pace/pace.min.js"></script>
	    <script src="js/libs/jquery-2.1.1.min.js"></script>
	    <script src="js/libs/jquery-ui-1.10.3.min.js"></script>
		<script src="js/app.config.js"></script>
		<script src="js/plugin/jquery-touch/jquery.ui.touch-punch.min.js"></script> 
		<script src="js/bootstrap/bootstrap.min.js"></script>
		<script src="js/app.min.js"></script>
		<script src="js/plugin/x-editable/moment.min.js"></script>
		<script src="js/plugin/x-editable/jquery.mockjax.min.js"></script>
		<script src="js/plugin/x-editable/x-editable.min.js"></script>
		<script src="js/bootstrap-treeview.js"></script>
		<script type="text/javascript">
			var id=0;
			var knowledgelist;
			$(document).ready(function() {
				$('#starttime').editable({
				       placement: 'right',
				       combodate: {
				           firstItem: 'name'
				       }
				   });
				$('#endtime').editable({
			        placement: 'right',
			        combodate: {
			            firstItem: 'name'
			        }
			    });
			})
			$.get("GetQuizlist",
				function(data){
					$('#tree').treeview({
						data: data,
						onNodeSelected: function(event, node) {
							changechoices(node);
						}
					});
				}
			);
			$.get("GetCollegelist",
					function(data){
						for(i=0;i<data.length;i++)
							$("#collegelist").append("<option value='"+data[i]+"'>"+data[i]+"</option>"); 
					}
				);
			$.get("GetRolelist",
					function(data){
						for(i=0;i<data.length;i++)
							$("#rolelist").append("<option value='"+data[i]+"'>"+data[i]+"</option>"); 
					}
				);
			$.get("GetYearlist",
					function(data){
						for(i=0;i<data.length;i++)
							$("#yearlist").append("<option value='"+data[i]+"'>"+data[i]+"</option>"); 
					}
				);
			$.ajax({  
		          type:"POST", 
		          url:"GetKnowledge", 
		          dataType:"json", 
		          async : true,
	   			  success:function(data){   //function1()
	   				knowledgelist=data;
		        }
		  	});
			function changechoices(node)
			{
				console.log(node.id);
				issimulate=node.issimulate;
				$('#quizid').val(node.id);
				$('#quizname').val(node.text);
				$("#starttime")[0].innerHTML=node.starttime; 
				$("#endtime")[0].innerHTML=node.endtime; 
				$("#timelast").val(node.time);
				$("#totalscore").val(node.totalsc);
				$("#passscore").val(node.passsc);
				$("#timelimits").val(node.times);
				if(issimulate==0)
				{
					$("#quiztype").val("formal");
				}
				else
				{
					$("#quiztype").val("simulate");
				}
				loadconfig(node.id);
			}
			function recalculate(){
				var fieldlist=$("#quizconfiglist").find("fieldset");
				var totalscore=0;
				for(i=0;i<fieldlist.length;i++)
				{
					var field=fieldlist[i];
					var count=field.childNodes[0].childNodes[2].childNodes[1].childNodes[0].childNodes[0].value;
					var score=field.childNodes[0].childNodes[3].childNodes[1].childNodes[0].childNodes[0].value;
					if(count!=""&&score!="")
						{
							if(isNaN(count)||isNaN(score))
							{
								alert("请输入正确数字");
								return;
							}
							else
								totalscore=totalscore+parseInt(count)*parseInt(score);
						}
				}
				$("#totalscore").val(totalscore);
			}
			function addconfig(){
				var config = document.createElement('fieldset');
				var html="<div class='row'><section class='col col-md-2'><label class='label'>知识点:</label><div class='col-md-6'><select class='form-control'>";
				for(j=0;j<knowledgelist.length;j++)
					html=html+"<option value='"+knowledgelist[j].id+"'>"+knowledgelist[j].text+"</option>";
				html=html+"</select></div></section><section class='col col-md-2'><label class='label'>题型:</label><div class='col-md-6'><select class='form-control typeselect'><option value='single'>单选</option><option value='multy'>多选</option><option value='check' selected='selected'>判断</option></select></div></section><section class='col col-md-2'><label class='label'>题目数量:</label><div class='col-md-6'><label class='input state-disabled'><input type='text' class='input-sm q-count'  onchange='recalculate();'></label></div></section><section class='col col-md-2'><label class='label'>每题分数:</label><div class='col-md-6'><label class='input state-disabled'><input type='text' class='input-sm q-score' onchange='recalculate();'></label></div></section><section class='col col-md-4'><label class='label'>删除:</label><div class='col-md-6'><a href='#' class='delete btn btn-labeled btn-danger col-md-5'> <span class='btn-label'><i class='glyphicon glyphicon-trash'></i></span>删除 </a></div></section></div>";
				config.innerHTML=html;
				var form = document.getElementById('quizconfiglist'); //2、找到父级元素
				form.appendChild(config);//插入到最左边
				$('.delete').click(function(){
					$(this).parent().parent().parent().parent().remove();
					recalculate();
				})
			}
			function loadconfig(id){
				$("#quizconfiglist").empty();
				$.post("GetQuizconfig",
						{id:id},
						function(data){
							for(i=0;i<data.length;i++)
								{
									var knowledgeid=data[i].knowledgeid;
									var type=data[i].type;
									var count=data[i].count;
									var score=data[i].score;
									var config = document.createElement('fieldset');
									var html="<div class='row'><section class='col col-md-2'><label class='label'>知识点:</label><div class='col-md-6'><select class='form-control'>";
									for(j=0;j<knowledgelist.length;j++)
									{
										if(knowledgelist[j].id==knowledgeid)
										{
											html=html+"<option value='"+knowledgelist[j].id+"' selected='selected'>"+knowledgelist[j].text+"</option>";
										}
										else
											html=html+"<option value='"+knowledgelist[j].id+"'>"+knowledgelist[j].text+"</option>";
									}
									html=html+"</select></div></section><section class='col col-md-2'><label class='label'>题型:</label><div class='col-md-6'><select class='form-control typeselect'>";
									if(type=="check")
										html=html+"<option value='single'>单选</option><option value='multy'>多选</option><option value='check' selected='selected'>判断</option>";
										else
											if(type=="single")
												html=html+"<option value='single' selected='selected'>单选</option><option value='multy'>多选</option><option value='check'>判断</option>";
												else
													html=html+"<option value='single'>单选</option><option value='multy' selected='selected'>多选</option><option value='check'>判断</option>";
									html=html+"</select></div></section><section class='col col-md-2'><label class='label'>题目数量:</label><div class='col-md-6'><label class='input state-disabled'><input type='text' class='input-sm q-count'  onchange='recalculate();' value='"+count+"'></label></div></section><section class='col col-md-2'><label class='label'>每题分数:</label><div class='col-md-6'><label class='input state-disabled'><input type='text' class='input-sm q-score' onchange='recalculate();' value='"+score+"''></label></div></section><section class='col col-md-4'><label class='label'>删除:</label><div class='col-md-6'><a href='#' class='delete btn btn-labeled btn-danger col-md-5'> <span class='btn-label'><i class='glyphicon glyphicon-trash'></i></span>删除 </a></div></section></div>";
									config.innerHTML=html;
									var form = document.getElementById('quizconfiglist'); //2、找到父级元素
									form.appendChild(config);//插入到最左边
									$('.delete').click(function(){
										$(this).parent().parent().parent().parent().remove();
										recalculate();
									})
								}
							recalculate();
						}
					);
			}
			function deletequiz(){
				$.get("DeleteQuiz",
						{id: $('#quizid').val()},
						function(data){
								if(data=="success")
									{
										alert("删除成功，如有需要可在回收站恢复");
										window.location.reload();
									}
								else
									{
										alert("删除失败");
										window.location.reload();
									}
						}
					);
			}
			function addquiz(){
				var name=$('#quizname').val();
				var starttime=$("#starttime")[0].innerHTML; 
				var endtime=$("#endtime")[0].innerHTML; 
				var timelast=$("#timelast").val();
				var totalscore=$("#totalscore").val();
				var passscore=$("#passscore").val();
				var timelimits=$("#timelimits").val();
				var type=$("#quiztype").val();
				if(type=="formal")
					{
						type=0;
					}
				else
					type=1;
				if(parseInt(passscore)>parseInt(totalscore))
					{
						alert("及格分不能超过总分！");
						return;
					}
				var fieldlist=$("#quizconfiglist").find("fieldset");
				var configs=[];
				for(i=0;i<fieldlist.length;i++)
				{
					var configobj={};
					field=fieldlist[i];
					configobj.knowledgeid=field.childNodes[0].childNodes[0].childNodes[1].childNodes[0].value;
					configobj.type=field.childNodes[0].childNodes[1].childNodes[1].childNodes[0].value;
					configobj.count=field.childNodes[0].childNodes[2].childNodes[1].childNodes[0].childNodes[0].value;
					configobj.score=field.childNodes[0].childNodes[3].childNodes[1].childNodes[0].childNodes[0].value;
					configs.push(configobj);
				}
				var st = JSON.stringify(configs);
				$.post("AddQuiz",
						{
							name:name,
							starttime:starttime,
							endtime:endtime,
							timelast:timelast,
							totalscore:totalscore,
							passscore:passscore,
							config:st,
							type:type,
							timelimit:timelimits
						},
						function(data){
							console.log(data);
							if(data=="success")
								{
									alert("添加成功");
									window.location.reload();
								}
							else
							{
								alert("添加失败");
								window.location.reload();
							}
							
						}
					);
			}
			function savequiz(){
				var name=$('#quizname').val();
				var starttime=$("#starttime")[0].innerHTML; 
				var endtime=$("#endtime")[0].innerHTML; 
				var timelast=$("#timelast").val();
				var totalscore=$("#totalscore").val();
				var passscore=$("#passscore").val();
				var timelimits=$("#timelimits").val();
				var type=$("#quiztype").val();
				if(type=="formal")
					{
						type=0;
					}
				else
					type=1;
				if(parseInt(passscore)>parseInt(totalscore))
					{
						alert("及格分不能超过总分！");
						return;
					}
				var fieldlist=$("#quizconfiglist").find("fieldset");
				var configs=[];
				for(i=0;i<fieldlist.length;i++)
				{
					var configobj={};
					field=fieldlist[i];
					configobj.knowledgeid=field.childNodes[0].childNodes[0].childNodes[1].childNodes[0].value;
					configobj.type=field.childNodes[0].childNodes[1].childNodes[1].childNodes[0].value;
					configobj.count=field.childNodes[0].childNodes[2].childNodes[1].childNodes[0].childNodes[0].value;
					configobj.score=field.childNodes[0].childNodes[3].childNodes[1].childNodes[0].childNodes[0].value;
					configs.push(configobj);
				}
				var st = JSON.stringify(configs);
				$.post("SaveQuiz",
						{
							id:$('#quizid').val(),
							name:name,
							starttime:starttime,
							endtime:endtime,
							timelast:timelast,
							totalscore:totalscore,
							passscore:passscore,
							config:st,
							type:type,
							timelimit:timelimits
						},
						function(data){
							console.log(data);
							if(data=="success")
								{
									alert("添加成功");
									window.location.reload();
								}
							else
							{
								alert("添加失败");
								window.location.reload();
							}
							
						}
					);
			}
			function DownloadGrades(){
				var id=$('#quizid').val();
				window.location.href="DownloadGrades?id="+id;
			}
			function DownloadRecords(){
				var id=$('#quizid').val();
				window.location.href="DownloadRecords?id="+id;
			}		
			$('#custom_download').click(function() {
				$('#dialog_simple').dialog('open');
				return false;
			});
			$('#dialog_simple').dialog({
				autoOpen : false,
				width : 600,
				resizable : false,
				modal : false,
				title : "选择筛选条件",
				buttons : [{
					html : "&nbsp; 下载成绩表",
					"class" : "btn btn-default",
					click : function() {
						var id=$('#quizid').val();
						var department=$("#collegelist option:selected").val(); 
						var role=$("#rolelist option:selected").val();
						var year=$("#yearlist option:selected").val(); 
						var gradestype=$("#gradestype option:selected").val(); 
						window.location.href="CumstomDownload?id="+id+"&department="+department+"&role="+role+"&year="+year+"&gradestype="+gradestype;
					}
				}, {
					html : "&nbsp; 下载分组统计表",
					"class" : "btn btn-default",
					click : function() {
						//$(this).dialog("close");
					}
				}]
			});
		</script>
	</body>

</html>